if(!window.Review){var Review=function(){}}var APA={submitAllowed:false,paymentSelected:false,Widgets:{ShippingMethod:Class.create({initialize:function(a){this.layer=$(APA.layers.shippingMethod);Object.extend(this,a);Event.stopObserving(this.layer,"widget:update").observe("widget:update",this.onUpdate.bindAsEventListener(this))},update:function(b){try{Element.update(this.layer,b);if(!this.layer.down("input[type=radio]:checked")){var a=this.layer.down("input[type=radio]");if(a){a.checked=true}}Event.stopObserving(this.layer,"change").observe("change",this.onShippingMethodSelect.bindAsEventListener(this));Event.stopObserving(this.layer,"widget:checked").observe("widget:checked",this.onShippingMethodSelect.bindAsEventListener(this));Event.fire(this.layer,"widget:update")}catch(c){this.onError(c)}}}),Review:Class.create({initialize:function(a){this.layer=$(APA.layers.review);Object.extend(this,a)},update:function(a){try{Element.update(this.layer,a)}catch(b){this.onError(b)}}})},setLoadWaiting:function(){for(var b=0;b<arguments.length;b++){if($(arguments[b])){var a=$(arguments[b]).up("li");a.addClassName("loading")}}return this},unsetLoadWaiting:function(){for(var b=0;b<arguments.length;b++){if($(arguments[b])){var a=$(arguments[b]).up("li");a.removeClassName("loading")}}return this},setOrderSaveWaiting:function(){if($(APA.layers.review)){var a=$(APA.layers.review).down(".please-wait");if(a){Element.show(a)}}if($("checkoutSteps")){$("checkoutSteps").insert({top:new Element("div",{"class":"amazon-widget-overlay"})})}this.disableSubmit()},unsetOrderSaveWaiting:function(){if($(APA.layers.review)){var a=$(APA.layers.review).down(".please-wait");if(a){Element.hide(a)}}if($("checkoutSteps")&&$("checkoutSteps").down(".amazon-widget-overlay")){$("checkoutSteps").down(".amazon-widget-overlay").remove()}this.toggleSubmit()},initCheckout:function(){this.disableSubmit().scaffoldPaymentWidget();if(this.virtual){return this.setLoadWaiting(APA.layers.wallet).renderWalletWidget().allowSubmit(true)}if(!this.orderReferenceId){return this.setLoadWaiting(APA.layers.shippingMethod,APA.layers.wallet,APA.layers.review).renderAddressBookWidget()}return this.setLoadWaiting(APA.layers.shippingMethod,APA.layers.wallet,APA.layers.review).renderAddressBookWidget().renderWalletWidget()},scaffoldPaymentWidget:function(){if(typeof APA.design.wallet.size!="undefined"&&!APA.design.responsive){if(APA.design.wallet.size.width){$(APA.layers.wallet).up().setStyle({width:APA.design.wallet.size.width})}if(APA.design.wallet.size.height){$(APA.layers.wallet).up().setStyle({height:APA.design.wallet.size.height})}}return this},renderButtonWidget:function(c){if(APA.urls.login!=null){$$(APA.layers.payButtons).each(function(d){new OffAmazonPayments.Button(d.identify(),APA.sellerId,{type:d.buttonType||APA.design.payButton.type||"PwA",size:d.buttonSize||APA.design.payButton.size,color:d.buttonColor||APA.design.payButton.color,authorization:function(){amazon.Login.authorize({scope:"profile payments:widget payments:shipping_address",popup:APA.popup},APA.urls.pay)},onError:APA.amazonErrorCallback})});$$(APA.layers.loginButtons).each(function(d){new OffAmazonPayments.Button(d.identify(),APA.sellerId,{type:d.buttonType||APA.design.loginButton.type||"LwA",size:d.buttonSize||APA.design.loginButton.size,color:d.buttonColor||APA.design.loginButton.color,authorization:function(){amazon.Login.authorize({scope:"profile payments:widget payments:shipping_address",popup:APA.popup},APA.urls.login)},onError:APA.amazonErrorCallback})})}else{$$(APA.layers.payButtons).each(function(d){new OffAmazonPayments.Widgets.Button({sellerId:APA.sellerId,useAmazonAddressBook:!APA.virtual,onSignIn:APA.signInCallback,onError:APA.amazonErrorCallback}).bind(d.identify())})}if(c&&typeof Tooltip!="undefined"){var b=$$(APA.layers.payButtons+","+APA.layers.loginButtons).findAll(function(d){return d.hasClassName("with-tooltip")});if(b.length){var a=document.createElement("div");a.setAttribute("id","pay-with-amazon-tooltip");a.addClassName("pay-with-amazon-tooltip");a.setStyle({display:"none",zIndex:10});a.update(c);document.body.appendChild(a);b.each(function(d){var e=d.down("img");if(e){new Tooltip(e,a)}})}}},signInCallback:function(a){var c=document.createElement("input");c.setAttribute("type","hidden");c.setAttribute("name","orderReferenceId");c.setAttribute("value",a.getAmazonOrderReferenceId());var b=document.createElement("form");b.setAttribute("method","post");b.setAttribute("action",APA.urls.checkout);b.appendChild(c);document.body.appendChild(b);b.submit();return},renderAddressBookWidget:function(){APA.setLoadWaiting(APA.layers.shippingMethod,APA.layers.review);new OffAmazonPayments.Widgets.AddressBook({sellerId:APA.sellerId,onOrderReferenceCreate:APA.orderReferenceCreateCallback,amazonOrderReferenceId:APA.orderReferenceId,design:(APA.design.responsive?{designMode:"responsive"}:APA.design.addressBook),onAddressSelect:APA.addressSelectCallback,onError:APA.amazonErrorCallback}).bind(APA.layers.addressBook);return this},orderReferenceCreateCallback:function(a){if(!APA.orderReferenceId){APA.orderReferenceId=a.getAmazonOrderReferenceId();if(!APA.virtual){APA.renderWalletWidget()}}},addressSelectCallback:function(){APA.selectPayment(false);APA.setLoadWaiting(APA.layers.shippingMethod,APA.layers.review);new Ajax.Request(APA.urls.saveShipping,{method:"post",parameters:{orderReferenceId:APA.orderReferenceId},evalScripts:true,onSuccess:APA.successCallback,onFailure:APA.ajaxFailureCallback})},renderShippingMethodWidget:function(a){APA.setLoadWaiting(APA.layers.review);new APA.Widgets.ShippingMethod({onShippingMethodSelect:APA.shippingMethodSelectCallback,onUpdate:APA.shippingMethodUpdateCallback,onError:APA.magentoErrorCallback}).update(a);return this},shippingMethodSelectCallback:function(a){APA.setLoadWaiting(APA.layers.review);new Ajax.Request(APA.urls.saveShippingMethod,{method:"post",parameters:Form.serialize($("co-shipping-method-form")),evalScripts:true,onSuccess:APA.successCallback,onFailure:APA.ajaxFailureCallback})},shippingMethodUpdateCallback:function(b){var a=Event.element(b);Event.fire(a,"widget:checked")},renderWalletWidget:function(){new OffAmazonPayments.Widgets.Wallet({sellerId:APA.sellerId,onOrderReferenceCreate:APA.orderReferenceCreateCallback,amazonOrderReferenceId:APA.orderReferenceId,design:(APA.design.responsive?{designMode:"responsive"}:APA.design.wallet),onPaymentSelect:APA.paymentSelectCallback,onError:APA.amazonErrorCallback}).bind(APA.layers.wallet);return this},paymentSelectCallback:function(){APA.selectPayment(true)},renderReviewWidget:function(a){new APA.Widgets.Review({onError:APA.magentoErrorCallback}).update(a);this.toggleSubmit();return this},successCallback:function(transport){response=eval("("+transport.responseText+")");if(response.error){APA.magentoErrorCallback(response.error_messages)}if(response.render_widget){$H(response.render_widget).each(function(pair){APA["render"+pair.key.capitalize().camelize()+"Widget"](pair.value);if(pair.value){APA.unsetLoadWaiting(APA.layers[pair.key.camelize()])}})}if(response.allow_submit){APA.allowSubmit(true)}else{APA.allowSubmit(false)}},saveOrderCallback:function(transport){response=eval("("+transport.responseText+")");if(response.success){window.location=APA.urls.success}if(response.redirect){window.location=response.redirect}if(response.error){APA.unsetOrderSaveWaiting();APA.magentoErrorCallback(response.error_messages)}},ajaxFailureCallback:function(){window.location.href=APA.urls.failure},amazonErrorCallback:function(a){if(!APA.live){console.trace();alert(a.getErrorMessage())}var b=["BuyerNotAssociated","BuyerSessionExpired","StaleOrderReference"];if(b.any(function(c){return c==a.getErrorCode()})){window.location.href=APA.urls.failure}},magentoErrorCallback:function(a){if(!APA.live){console.trace()}if(typeof(a)=="object"){a=a.join("\n")}if(a){alert(a)}},allowSubmit:function(a){this.submitAllowed=a;return this.toggleSubmit()},selectPayment:function(a){this.paymentSelected=a;return this.toggleSubmit()},toggleSubmit:function(){if(this.submitAllowed&&this.paymentSelected){return this.enableSubmit()}return this.disableSubmit()},disableSubmit:function(){var a=$(this.layers.review).select("div.buttons-set");if(a){a.each(function(b){b.addClassName("disabled");var c=b.down("button[type=submit].button");if(c){c.disabled=true}})}return this},enableSubmit:function(){if(this.submitAllowed&&this.paymentSelected){var a=$(this.layers.review).select("div.buttons-set");if(a){a.each(function(b){b.removeClassName("disabled");var c=b.down("button[type=submit].button");if(c){c.disabled=false}})}}return this},saveOrder:function(){APA.setOrderSaveWaiting();new Ajax.Request(APA.urls.saveOrder,{method:"post",parameters:APA.getSaveOrderParams(),onSuccess:APA.saveOrderCallback,onFailure:APA.ajaxFailureCallback})},getSaveOrderParams:function(){var a="";if(APA.virtual){a+=Object.toQueryString({orderReferenceId:APA.orderReferenceId});if($("checkout-agreements")){a+="&"+Form.serialize($("checkout-agreements"))}}else{a=Form.serialize($("co-shipping-method-form"));if($("checkout-agreements")){a+="&"+Form.serialize($("checkout-agreements"))}}a.save=true;return a},initialize:function(c,a,d,g,f,e,b){return Object.extend(APA,{sellerId:c,orderReferenceId:a,live:d,virtual:g,urls:Object.extend({login:null,pay:null,checkout:null,saveShipping:null,saveShippingMethod:null,saveOrder:null,success:null,failure:null},f),layers:Object.extend({payButtons:".payButtonWidget",loginButtons:".loginButtonWidget",addressBook:"addressBookWidgetDiv",wallet:"walletWidgetDiv",shippingMethod:"shippingMethodWidgetDiv",review:"reviewWidgetDiv"},e),design:Object.extend({addressBook:{size:{width:"440px",height:"260px"}},wallet:{size:{width:"440px",height:"260px"}},payButton:{type:"PwA"},loginButton:{type:"LwA"}},b)})},setup:function(b,a){return Object.extend(APA,{sellerId:b,orderReferenceId:typeof a.orderReferenceId=="undefined"?null:a.orderReferenceId,live:typeof a.live=="undefined"?true:a.live,popup:typeof a.popup=="undefined"?true:a.popup,virtual:typeof a.virtual=="undefined"?false:a.virtual,layers:Object.extend({payButtons:".payButtonWidget",loginButtons:".loginButtonWidget",addressBook:"addressBookWidgetDiv",wallet:"walletWidgetDiv",shippingMethod:"shippingMethodWidgetDiv",review:"reviewWidgetDiv"},a.layers),urls:Object.extend({login:null,pay:null,checkout:null,saveShipping:null,saveShippingMethod:null,saveOrder:null,success:null,failure:null},a.urls),design:Object.extend({responsive:true,addressBook:{size:{width:"440px",height:"260px"}},wallet:{size:{width:"440px",height:"260px"}},payButton:{type:"PwA"},loginButton:{type:"LwA"}},a.design)})}};